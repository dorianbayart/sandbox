<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Pixel Perfect Converter</title>

</head>

<body>
  <header>
    <h1 class="cursive">Pixel Perfect Converter</h1>
  </header>

  <main>
    <section class="centered">

      <div class="input-section">
        <h2>Input Image</h2>
        <div class="flex">
          <input type="file" id="imageUpload" accept="image/*">
          <span>OR</span>
          <textarea id="base64Input" placeholder="Paste base64 image data here..."></textarea>
        </div>
        <div class="image-preview" id="inputImagePreview">Preview</div>
        <span id="inputImageSize" class="image-size"></span>
      </div>

    </section>

    <hr>
    
    <section class="centered">

      <div class="output-section">
        <h2>Output SVG</h2>
        <div id="svgLoader" class="loader"></div>
        <textarea id="svgOutput" readonly></textarea>
        <div class="svg-preview" id="outputSvgPreview">Preview</div>
        <span id="outputSvgSize" class="svg-size"></span>
        <div class="output-buttons">
            <button id="copySvgButton">Copy SVG</button>
            <button id="downloadSvgButton">Download SVG</button>
        </div>
      </div>

    </section>
  </main>


  <script>
    // JavaScript will go here
    const imageUpload = document.getElementById('imageUpload');
    const base64Input = document.getElementById('base64Input');
    const inputImagePreview = document.getElementById('inputImagePreview');
    const inputImageSize = document.getElementById('inputImageSize');
    const svgOutput = document.getElementById('svgOutput');
    const outputSvgPreview = document.getElementById('outputSvgPreview');
    const outputSvgSize = document.getElementById('outputSvgSize');
    const copySvgButton = document.getElementById('copySvgButton');
    const downloadSvgButton = document.getElementById('downloadSvgButton');
    const svgLoader = document.getElementById('svgLoader');

    let currentImageBase64 = '';

    async function processImage(base64Data) {
      if (base64Data) {
        inputImagePreview.innerHTML = `<img src="${base64Data}" alt="Input Image Preview">`;
        currentImageBase64 = base64Data;

        const img = new Image();
        img.onload = async () => {
          inputImageSize.textContent = `Original Size: ${img.width}x${img.height} pixels`;

          // Calculate and display input image size in bytes
          try {
            const response = await fetch(base64Data);
            const blob = await response.blob();
            inputImageSize.textContent += ` (${formatBytes(blob.size)})`;
          } catch (error) {
            console.error('Failed to fetch image blob for size calculation:', error);
            inputImageSize.textContent += ' (Size unknown)';
          }

          // Show loader and clear previous SVG output
          svgLoader.style.display = 'block';
          svgOutput.value = '';
          outputSvgPreview.innerHTML = '';
          outputSvgSize.textContent = '';

          try {
            const svgResult = await convertToPixelPerfectSVG(base64Data);
            svgOutput.value = svgResult;
            outputSvgPreview.innerHTML = svgResult;
            const svgBlob = new Blob([svgResult], { type: 'image/svg+xml' });
            outputSvgSize.textContent = `SVG Size: ${formatBytes(svgBlob.size)}`;
          } catch (error) {
            console.error('SVG conversion failed:', error);
            alert('Failed to convert image to SVG. Please check the console for details.');
            svgOutput.value = '';
            outputSvgPreview.innerHTML = '';
            outputSvgSize.textContent = '';
          } finally {
            svgLoader.style.display = 'none'; // Hide loader regardless of success or failure
          }
        };
        img.onerror = () => {
            inputImageSize.textContent = 'Invalid image data';
            inputImagePreview.innerHTML = '';
            currentImageBase64 = '';
            svgOutput.value = '';
            outputSvgPreview.innerHTML = '';
            outputSvgSize.textContent = '';
            svgLoader.style.display = 'none'; // Hide loader on image load error
        };
        img.src = base64Data;

      } else {
        inputImagePreview.innerHTML = '';
        inputImageSize.textContent = '';
        currentImageBase64 = '';
        svgOutput.value = '';
        outputSvgPreview.innerHTML = '';
        outputSvgSize.textContent = '';
        svgLoader.style.display = 'none'; // Hide loader if no base64 data
      }
    }

    imageUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          base64Input.value = e.target.result; // Sync base64 input
          processImage(e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        base64Input.value = '';
        processImage('');
      }
    });

    base64Input.addEventListener('input', (event) => {
      processImage(event.target.value);
      imageUpload.value = ''; // Clear file input if base64 is manually entered
    });

    copySvgButton.addEventListener('click', () => {
      svgOutput.select();
      document.execCommand('copy');
      alert('SVG copied to clipboard!');
    });

    downloadSvgButton.addEventListener('click', () => {
      const svgContent = svgOutput.value;
      if (svgContent) {
        const blob = new Blob([svgContent], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pixel-perfect.svg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else {
        alert('No SVG to download.');
      }
    });

    // Helper function to format bytes into human-readable sizes
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';

      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB'];

      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function convertToPixelPerfectSVG(base64Image) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          const data = imageData.data;

          let svgRects = [];
          for (let y = 0; y < img.height; y++) {
            for (let x = 0; x < img.width; x++) {
              const index = (y * img.width + x) * 4;
              const alpha = data[index + 3]; // Alpha channel

              if (alpha > 0) { // Only draw if not fully transparent
                const r = data[index];
                const g = data[index + 1];
                const b = data[index + 2];
                const color = `rgb(${r},${g},${b})`;
                svgRects.push(`<rect x="${x}" y="${y}" width="1" height="1" fill="${color}"/>`);
              }
            }
          }

          const svgContent = `<svg width="${img.width}" height="${img.height}" viewBox="0 0 ${img.width} ${img.height}" xmlns="http://www.w3.org/2000/svg">
${svgRects.join("\n")}
</svg>`;
          resolve(svgContent);
        };
        img.src = base64Image;
      });
    }
  </script>




  <footer>
    <div id="footer">&copy; 2000 <a href="https://github.com/dorianbayart" title="DorianBayart on GitHub">0xDBA</a>
    </div>
  </footer>

  <script>
    const currentYear = new Date().getFullYear()
    document.querySelector('footer div#footer').innerHTML = `&copy; ${currentYear} <a href="https://github.com/dorianbayart" title="DorianBayart on GitHub">0xDBA</a>`
  </script>

</body>

<link rel="stylesheet" href="common.css">

</html>